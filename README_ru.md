# Тестовое задание Селектел

## Общее описание

Репозиторий содержит скрпты Terraform и Ansible, позволяющие
поднять и настроить необходимую инфраструктуру.

Генерируются следующие (виртуальные) серверы:
* "рабочие" сервера `server-X`, где `X` - 0, 1, 2..., по числу,
  указанному в переменной `server_count`: `server-0`, `server-1`...
* управляющий сервер `management-server` с установленным Prometheus.

Разворачивание системы:

1. Создать проект в панели управления
1. Выставить необходимые переменные (см. ниже)
1. Запустить Terraform, чтобы поднять сервера. Terraform
   также сгенерирует некоторые файлы, необходимые для последующей
   работы Ansible.
1. Запустить Ansible для настройки серверов.

Детальные инструкции приведены ниже.

## Подготовительные шаги

1. Создать проект в панели управления
1. Создать пользователя `tform` (или пользователя с другими именем,
   и установить это имя в переменной `user_name` в `provider.tf`)
1. Выставить квоту по floating IP в достаточный уровень для запуска
   нужного количества серверов. Требуемое количество равняется
   количеству "рабочих" серверов + 1 на управляющий сервер.

## Настроить Terraform

1. Выставить `domain_name` в номер аккаунта в `provider.tf`.
1. Выстаить `tenant_id` в `provider.tf` в ID проекта.
1. Выставить переменную окружения `TF_VAR_selectel_tform_passwd` в
   пароль пользователя `tform`.
1. Установить `region`, `az_zone`, `volume_type`, `subnet_cidr` в `vars.tf`.
1. Установить желаемое количество "рабочих" серверов в `server_count` в `vars.tf`.
1. Сгенерировать ключевую пару SSH. Скопировать значение публичного ключа
   в переменную `public_key` в `keys.tf`. Выставить `private_key_file` в
   файле `vars.tf` в путь до файла с приватным ключом.

## Запустить `terraform init`, `plan` и `apply`

Выполнить
```
terraform init
terraform plan
terraform apply
```
**Обратите внимание**: для установки провайдеров Terraform может потребоваться VPN.

При успешном запуске Terraform запишет два файла:

1. Файл `files/ssh_config`, который можно использовать
   для подключения к серверам по SSH:
   ```
   ssh -F files/ssh_config server-0
   ```
1.  Ansible inventory в файле `./ansible/inventory/hosts`.

## Выполнить Ansible playbook

1. При необходимости, поменять версии Prometheus и Node Exporter,
   указанные в `ansible/playbooks/setup.yml`.

2. Для настройки серверов через Ansible, перейти в каталог `./ansible/`
   и выполнить плейбук `setup.yml`:
   ```
   cd ansible/
   ansible-playbook playbooks/setup.yml
   ```

   Возможно, будет нужно подождать несколько секунд, чтобы сервра стали доступны
   по SSH.

## Веб-интерфейс Prometheus

IP-адрес сервера Prometheus можно найти в файле `files/ssh_config`
(`Host management-server`). Переход на страницу будет возможен по адресу
http://MANAGEMENT-SERVER-IP:9090/ .

## Замечания

1. https://releases.hashicorp.com/terraform/ блокирует доступ (из России?)
1. Было решено запускать Ansible не в качестве provisioner Terraform-а,
   чтобы иметь доступ ко всему инвентори, а не только к текущему серверу.
